\section{Le calage automatique du coefficient de Strickler}

\underline{Avertissement} : ce calage n'est possible qu'en régime permanent (noyau \texttt{SARAP}) et sur un seul bief avec la version actuelle de \texttt{MASCARET}.

\subsection{Introduction}

Pour la modélisation hydraulique 1D et 2D basée sur la résolution des équations de Saint-Venant, il est nécessaire de disposer de différentes données que sont la géométrie, les conditions initiales en régime non permanent, les conditions limite et le coefficient de Strickler. Toutes les données, hormis le coefficient de Strickler, sont parfaitement définies par les conditions d'étude (les données de géométrie sont fournies par des campagnes de mesures ; les conditions aux limites et les conditions initiales correspondent au cas d'étude).

\vspace{0.5cm}

Le coefficient de Strickler modélise les pertes de charge linéaires dues au frottement sur le fond et les berges le long de la rivière. Or, dans le cadre d'une modélisation monodimensionnelle, il prend aussi en compte des phénomènes de dissipation qui ne sont pas modélisés par ailleurs. Par conséquent, la détermination de ce coefficient nécessite un calage, réalisé à partir de lignes d'eau mesurées pour des débits du même ordre de grandeur que ceux de l'étude.

\vspace{0.5cm}

Cette étape de calage, absolument essentielle pour la qualité de l'étude, est une des étapes les plus consommatrices en temps dans une étude.

\vspace{0.5cm}

Dans ce chapitre, nous présentons la méthode d'identification des coefficients de Strickler intégrée au système \texttt{MASCARET} et basée sur la résolution d'un problème inverse. Cette méthode d'identification des paramètres de calage permet de diminuer une des phases les plus longues des études et ainsi obtenir des gains importants sur les délais et de mieux maîtriser les incertitudes liées aux coefficients de Strickler.

\vspace{0.5cm}

La première partie est consacrée à  la présentation générale d'un problème d'identification de paramètres. Puis, nous présentons l'algorithme complet appliqué au cas du coefficient de Strickler.

\vspace{0.5cm}

La validation sur des cas schématiques et sur un cas réel est détaillée dans la note \cite{GOUTAL05}.

\subsection{Position du problème}

\label{PosPb}

Dans ce premier paragraphe, nous présentons brièvement le problème d'identification du coefficient de Strickler. L'estimation de paramètres revient à trouver les coefficients de Strickler qui minimisent une fonction coût $J$ égale à  l'écart quadratique entre les mesures et le résultat d'une simulation numérique. On rappelle le principe général des méthodes existantes pour la minimisation d'un problème à plusieurs variables.

\vspace{0.5cm}

Considérons un écoulement permanent sur un tronçon de rivière. On dispose d'un certain nombre de points de mesure avec les cotes correspondant au débit qui nous intéresse. A partir de ces mesures, on cherche à  identifier le coefficient de Strickler (ou les coefficients de Strickler sur différentes zones du domaine) qui va minimiser la fonctionnelle $J$ suivante :

\begin{equation}
 J(K) = \sum_{i=1..m} \alpha_i ( Z_{i}^m - Z_{i}^c (K) )^2
\end{equation}

o\`{u} :
\begin{itemize}
 \item $m$ est le nombre de points de mesure;
 \item $\alpha_i$ est une pondération pour chaque mesure (ce coefficient peut être égal à zéro si la mesure n'est pas disponible);
 \item $Z_{i}^m$ est la cote mesurée au point $i$ pour le débit considéré;
 \item $Z_{i}^c$ est la cote calculée au point $i$ par la résolution des équations de Saint-Venant avec un ensemble de coefficients de Strickler $K_i$.
\end{itemize}

\vspace{0.5cm}

\underline{Remarques} :
\begin{itemize}
 \item $J$ est une fonction coût qui mesure l'écart quadratique entre la cote mesurée et la cote calculée pour un ensemble de coefficients de Strickler donné;
 \item $J$ n'est pas connue analytiquement. Pour la déterminer, il faut évaluer les cotes calculées pour un jeu de coefficients de Strickler donné à  l'aide d'une résolution d'un problème de Saint-Venant.
\end{itemize}

\vspace{0.5cm}

Pour minimiser la fonctionnelle $J$, on peut trouver dans la littérature de nombreuses méthodes d'optimisation. A l'heure actuelle, la méthode utilisée est de type quasi-Newton BFGS avec prises en compte des contraintes de bornes sur les variables d'optimisation. Cette méthode du second ordre ne nécessite pas le calcul exacte de la Hessienne car elle est approximée par l'analyse itérative des différents gradients.

\vspace{0.5cm}

L'algorithme de quasi-Newton a la forme générale suivante :
\begin{itemize}
 \item[1]) détermination du point de départ $x_0$ et d'une matrice Hessienne approchée $B_0$ (par exemple l'identité);
 \item[2]) pour : $k= 0,1,2...$ jusqu'à convergence :
   \begin{itemize}
     \item calculer $d_k$ en résolvant : $B_k.d_k = -\nabla J(x_k)$;
     \item mettre à jour la solution avec une recherche linéaire :
                    
                     $x_{k+1} = x_k + \alpha_k.d_k$;
     \item mettre à jour la matrice $B_{k+1}$ par la formule BFGS;
   \end{itemize}
\end{itemize}

\vspace{0.5cm}

La convergence peut être testée sur la nullité du gradient (condition nécessaire d'optimalité). 

\vspace{0.5cm}

Cette méthode n'a pas de convergence garantie. Elle est cependant performante si la fonction à optimiser admet un développement de Taylor quadratique près de l'optimum.

\subsection{Algorithme d'identification des coefficients de Strickler}

Dans ce paragraphe, on présente succinctement l'algorithme d'identification des coefficients de Strickler pour un écoulement monodimensionnel permanent sur un seul bief et la méthode de quasi-Newton pour minimiser la fonction coût.

\subsubsection{Rappels des équations de Saint-Venant}

On représente l'écoulement filaire d'une rivière par un système d'équations aux dérivées partielles où le frottement a été modélisé par la relation de Strickler. Ces équations sont obtenues à partir des équations de Navier-Stokes après plusieurs hypothèses simplificatrices dont :

\begin{itemize}
 \item une direction des vitesses uniforme;
 \item un profil des vitesses constant sur une section de la rivière.
\end{itemize}

\vspace{0.5cm}

En régime permanent, on se donne des conditions limites qui sont un débit à  l'entrée du domaine de modélisation et une cote ou une relation hauteur-débit à  l'aval.

\vspace{0.5cm}

Les inconnues sont la cote en chaque point du domaine de calcul : $[x_0,x_1]$. Le débit est déterminé par la condition à  la limite amont et les apports de débit le long du domaine de calcul $[x_0,x_1]$.

\begin{equation}
  \label{ContCas}
  \frac{\partial Q}{\partial x}= q_a
\end{equation}

\begin{equation}
  \label{DynCas}
  \frac{\partial}{\partial x} \left ( \frac{Q^2}{S(Z)} \right ) + g S(Z) \frac{\partial Z}{\partial x} + \frac{g Q^2}{K^2 S(Z) R^{\frac{4}{3}}} = 0
\end{equation}

\begin{equation}
 \left \lbrace
  \begin{array}{l}
    Q(x_0) = Q_{am} \\
    Z(x_1) = Z_{aval}
  \end{array}
 \right.
\end{equation}

avec:
\begin{itemize}
  \item $x$ est l'abscisse curviligne le long de la rivière;
  \item $Q$ est le débit;
  \item $S(Z)$ est la section mouillée de la rivière dépendant de la cote;
  \item $R$ est le rayon hydraulique, $g$ la gravité et $K$ le coefficient de Strickler qui dépend de $x$. En fait, ce coefficient sera considéré constant par zone.
\end{itemize}

\vspace{0.5cm}

L'équation de continuité (\ref{ContCas}) permet de calculer le débit en tous points du domaine de calcul, connaissant le débit imposé à  la condition limite amont 

\vspace{0.5cm}

L'équation (\ref{DynCas}) de quantité de mouvement est une équation différentielle qui est discrétisée par différences finies. Après discrétisation, on a à  résoudre une équation de la forme : $Z=F(Z)$.

\vspace{0.5cm}

Ce qui revient à  chercher les zéros de la fonction : $Z-F(Z)$. A chaque résolution d'un problème de Saint-Venant, on fait alors appel au noyau de calcul dédié à  la résolution des équations de Saint-Venant en régime permanent du système \texttt{MASCARET}. Pour plus de détails, on peut se reporter au chapitre consacré aux principes du noyau fluvial permanent.

\vspace{0.5cm}

La solution de cette équation différentielle, c'est-à -dire les cotes calculées en chaque point discret du domaine dépend du coefficient de Strickler qui n'est pas une donnée du problème mais résulte d'un calage.

\subsubsection{Présentation du programme d'optimisation}

Dans la présentation de l'algorithme d'identification du coefficient de Strickler, la phase de résolution du problème discret de Saint-Venant permanent est appelée \textit{résolution d'un problème de Saint-Venant permanent pour un ensemble discret de coefficients de Strickler définis par zone}.

\vspace{0.5cm}

Le programme de minimisation utilisé se nomme \texttt{N2QN1} de la librairie MODULOPT\footnote{\url{https://who.rocq.inria.fr/Jean-Charles.Gilbert/modulopt/modulopt.html}} développé et maintenu principalement par les membres du projet ESTIME de l'Institut National pour la Recherche en Informatique et Automatique (INRIA). Ce solveur est adapté aux problèmes de minimisation ``bornés`` d'une fonction objectif $J$ avec des contraintes fixes, et ayant un très grand nombre de variables. Il utilise une méthode de type quasi-Newton BFGS avec contraintes. L'intérêt des bornes est de pouvoir limiter la recherche de coefficients de frottements à des valeurs cohérentes d'un point de vue physique.

\vspace{0.5cm}

Comme indiqué précédemment, le fonctionnement interne du solveur \texttt{N2QN1} s'appuie sur une estimation de la matrice Hessienne de la fonction coût étudiée. Il comporte plusieurs modes d'initialisation de cette matrice 
(initialisation scalaire et initialisation vectorielle) et nécessite le passage de plusieurs paramètres, dont en particulier :
\begin{itemize}
\item le vecteur d'entrée de la fonction étudiée (ici le coefficient de frottement);
\item la valeur de la fonction coût;
\item le gradient relatif à la valeur de la fonction coût;
\item divers paramètres internes (comme le nombre de simulations, d'itérations, la précision attendue, etc.).
\end{itemize}

\vspace{0.5cm}

Le principe général est de fournir au solveur les paramètres décrits plus haut, ainsi qu'un pointeur vers une fonction simulateur. Celle-ci doit calculer la valeur de la fonction coût et le gradient de celle-ci à partir des paramètres d'entrée fournis par le minimiseur (dans notre cas le coefficient de frottement). Ces paramètres sont modifiés en regard de la précédente itération, elle même basée sur la valeur de la fonction coût et du gradient. Le solveur \texttt{N2QN1} peut avoir à tester plusieurs directions avant d'arriver à estimer convenablement le minimum. Le simulateur est appelé jusqu'à ce qu'un des critères d'arrêt soit atteint.

\vspace{0.5cm}

Ces critères sont modélisés par les paramètres $epsabs$ et $dxmin$, qui représentent respectivement la précision requise sur chaque coefficient de frottement $K$, et la précision du gradient. \texttt{N2QN1} s'arrête lorsqu'il trouve $K_{k}$ tel que, pour obtenir $K_{k+1}$ avec $J(K_{k+1})\leq J(K_{k})$ il doit prendre $|K_{k+1}^{i}-K_{k}^{i}| \leq dxmin^{i},\;\; i = 1,..,N_{zones}$, ou lorsque $||\nabla J_{k}|| \leq epsabs$.

\vspace{0.5cm}

Le coefficient de frottement obtenu après convergence avec la méthode de quasi-Newton BFGS avec contraintes doit permettre un calcul de cotes très proches des cotes mesurées. L'ensemble de la résolution implémentée dans \texttt{N2QN1} est basée sur une approximation de la Hessienne de la fonction objectif, qui est calculée à partir du gradient de cette dernière. Or, si ce gradient est obtenu par différences finies, il est lui-même une approximation. Cette double approximation peut entraîner une perte d'information très importante. Les résultats qui en découlent manquent alors de précision.

\vspace{0.5cm}

Pour palier à ce problème, il est nécessaire de calculer le gradient analytique de la fonction coût par rapport au coefficient de frottement plutôt qu'une approximation de celui-ci par différences finies. Ce calcul 
est difficile pour un code industriel comme \texttt{MASCARET}. Il existe des outils mathématiques de différentiation automatique d'un code de calcul (voir par exemple :\url{http://www.autodiff.org/}),permettant le calcul de dérivées exactes. L'un de ces outils, le logiciel \texttt{TAPENADE} \cite{HASCOET13} développé par l'INRIA \footnote{\url{http://www-tapenade.inria.fr:8080/tapenade/index.jsp}}, a été choisi pour rendre viable l'utilisation de la méthode de quasi-Newton BFGS.

\subsection{Méthode de calage d'un lit composé}

Les coefficients de Strickler des lits mineurs et majeurs sont fixés par zones pour calculer une ligne d'eau mesurée pour un débit de plein bord et un débit débordant. En première étape, une estimation des coefficients de Strickler du lit mineur est réalisée par calage automatique à  partir de la ligne d'eau mesurée pour le débit de plein bord. Puis, avec ces coefficients de Strickler mineurs obtenus par calage automatique, on estime dans un deuxième temps, par calage automatique, les coefficients de Strickler du lit majeur dans le cas du débit débordant.

\subsection{Validation et conclusions}

La validation de l'algorithme d'identification de paramètres a été faite dans un premier temps sur un cas schématique, ce qui a permis de contrôler la solution obtenue, puis l'algorithme a été appliqué à  une étude réelle.

\vspace{0.5cm}

En cas de régime permanent, le calage automatique du coefficient de Strickler par une méthode d'identification de paramètres avec un calcul de gradient de la fonction coût donne des résultats satisfaisants sur des cas schématiques et sur des cas réels. Néanmoins, il faut noter une convergence qui n'est pas extrêmement rapide surtout lorsqu'on approche d'un minimum local. Dans les cas pratiques, la précision obtenue suffit car il n'est pas réaliste de souhaiter une précision supérieure au $cm$ sur des mesures.

\vspace{0.5cm}

Les prochains développements concerneront d'une part la prise en compte du régime transitoire en introduisant le problème adjoint pour évaluer le gradient de la fonction coût et d'autre part le changement de la méthode de minimisation pour d'autres méthodes plus robustes et plus récentes (méthode du gradient conjugué ou les méthodes de Quasi-Newton).

